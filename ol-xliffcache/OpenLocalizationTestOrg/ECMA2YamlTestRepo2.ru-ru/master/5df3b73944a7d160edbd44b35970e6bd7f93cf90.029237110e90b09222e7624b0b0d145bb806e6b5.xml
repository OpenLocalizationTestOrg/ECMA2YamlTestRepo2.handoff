{"nodes":[{"pos":[1834,1906],"content":"The abstract base class from which all persistence services are derived.","needQuote":true,"needEscape":true,"nodes":[{"content":"The abstract base class from which all persistence services are derived.","pos":[0,72]}]},{"pos":[1919,5999],"content":"> [!NOTE] >  [!INCLUDE[DeprecatedContent](~/add/includes/ajax-current-ext-md.md)]       When certain conditions occur while the workflow is running, the workflow runtime engine persists state information about the workflow instance. Persistence can occur, for example, when an atomic transaction finishes, when the workflow instance becomes idle, when the host calls <xref:System.Workflow.Runtime.WorkflowInstance.Unload%2A?displayProperty=fullName> on the workflow instance, or when a workflow instance is terminated or finishes. When the workflow runtime engine semantics dictate that persistence should occur, the workflow runtime engine calls methods that are supplied by a persistence service to save state information about the workflow instance. Likewise, when the workflow runtime engine needs to restore a previously persisted workflow instance, it calls methods that are supplied by the persistence service to load this state information. The workflow runtime engine handles all the semantics regarding when to perform persistence. The persistence service handles actually saving and loading the workflow state information to or from a data store.       You can create a persistence service by deriving a class from the WorkflowPersistenceService class.  You can add your persistence service to the workflow runtime engine by calling <xref:System.Workflow.Runtime.WorkflowRuntime.AddService%2A> or by making an appropriate entry in the application configuration file. The <xref:System.Workflow.Runtime.WorkflowRuntime> should only contain one persistence service. Windows Workflow Foundation provides the <xref:System.Workflow.Runtime.Hosting.SqlWorkflowPersistenceService> class, an out-of-box persistence service, which you can use as is or extend.       The workflow runtime engine has semantics for locking workflow state information for use in environments where persistence services that run in different processes might have access to a single data store. The WorkflowPersistenceService class provides the capability to support this functionality of the workflow runtime engine by providing a parameter to <xref:System.Workflow.Runtime.Hosting.WorkflowPersistenceService.SaveWorkflowInstanceState%2A> that specifies whether the state information of a workflow instance should be unlocked in the data store, and by providing a method <xref:System.Workflow.Runtime.Hosting.WorkflowPersistenceService.UnlockWorkflowInstanceState%2A> to unlock previously locked workflow state information. In a persistence service that implements locking, a call to <xref:System.Workflow.Runtime.Hosting.WorkflowPersistenceService.LoadWorkflowInstanceState%2A> should lock the state information for a workflow instance.       Your persistence service should throw a <xref:System.Workflow.Runtime.Hosting.PersistenceException> if it fails to save state information to its data store or load state information from its data store. The workflow runtime engine expects this behavior.       A batching mechanism is provided for services that use a durable store to save workflow state information. It is important in these cases to maintain consistency between the durable store that is used by the persistence service and the internal state of the workflow runtime engine. You can add functionality defined by the <xref:System.Workflow.Runtime.IPendingWork> interface to your service, and then participate in workflow transaction batching provided by the <xref:System.Workflow.Runtime.Hosting.WorkflowCommitWorkBatchService> by adding changes to your data store as work items to the <xref:System.Workflow.Runtime.WorkflowEnvironment.WorkBatch%2A>. The durable store itself should implement the <xref:System.Transactions.IEnlistmentNotification> interface, so that workflow information is not persisted incorrectly in the event of a transaction rollback. For more information, see <xref:System.Workflow.Runtime.Hosting.WorkflowPersistenceService.SaveCompletedContextActivity%2A> or <xref:System.Workflow.Runtime.Hosting.WorkflowPersistenceService.SaveWorkflowInstanceState%2A>.","needQuote":false,"needEscape":true,"extradata":"MT","nodes":[{"content":"<ph id=\"ph1\">&gt; [!NOTE]</ph><ph id=\"ph2\"> &gt;  </ph><ph id=\"ph3\">[!INCLUDE[DeprecatedContent](~/add/includes/ajax-current-ext-md.md)]</ph>       When certain conditions occur while the workflow is running, the workflow runtime engine persists state information about the workflow instance.","pos":[0,232],"source":"> [!NOTE] >  [!INCLUDE[DeprecatedContent](~/add/includes/ajax-current-ext-md.md)]       When certain conditions occur while the workflow is running, the workflow runtime engine persists state information about the workflow instance."},{"content":"Persistence can occur, for example, when an atomic transaction finishes, when the workflow instance becomes idle, when the host calls &lt;xref:System.Workflow.Runtime.WorkflowInstance.Unload%2A?displayProperty=fullName&gt; on the workflow instance, or when a workflow instance is terminated or finishes.","pos":[233,530],"source":" Persistence can occur, for example, when an atomic transaction finishes, when the workflow instance becomes idle, when the host calls <xref:System.Workflow.Runtime.WorkflowInstance.Unload%2A?displayProperty=fullName> on the workflow instance, or when a workflow instance is terminated or finishes."},{"content":"When the workflow runtime engine semantics dictate that persistence should occur, the workflow runtime engine calls methods that are supplied by a persistence service to save state information about the workflow instance.","pos":[531,752]},{"content":"Likewise, when the workflow runtime engine needs to restore a previously persisted workflow instance, it calls methods that are supplied by the persistence service to load this state information.","pos":[753,948]},{"content":"The workflow runtime engine handles all the semantics regarding when to perform persistence.","pos":[949,1041]},{"content":"The persistence service handles actually saving and loading the workflow state information to or from a data store.","pos":[1042,1157]},{"content":"You can create a persistence service by deriving a class from the WorkflowPersistenceService class.","pos":[1164,1263]},{"content":"You can add your persistence service to the workflow runtime engine by calling &lt;xref:System.Workflow.Runtime.WorkflowRuntime.AddService%2A&gt; or by making an appropriate entry in the application configuration file.","pos":[1265,1477],"source":"  You can add your persistence service to the workflow runtime engine by calling <xref:System.Workflow.Runtime.WorkflowRuntime.AddService%2A> or by making an appropriate entry in the application configuration file."},{"content":"The &lt;xref:System.Workflow.Runtime.WorkflowRuntime&gt; should only contain one persistence service.","pos":[1478,1573],"source":" The <xref:System.Workflow.Runtime.WorkflowRuntime> should only contain one persistence service."},{"content":"Windows Workflow Foundation provides the &lt;xref:System.Workflow.Runtime.Hosting.SqlWorkflowPersistenceService&gt; class, an out-of-box persistence service, which you can use as is or extend.","pos":[1574,1760],"source":" Windows Workflow Foundation provides the <xref:System.Workflow.Runtime.Hosting.SqlWorkflowPersistenceService> class, an out-of-box persistence service, which you can use as is or extend."},{"content":"The workflow runtime engine has semantics for locking workflow state information for use in environments where persistence services that run in different processes might have access to a single data store.","pos":[1767,1972]},{"content":"The WorkflowPersistenceService class provides the capability to support this functionality of the workflow runtime engine by providing a parameter to &lt;xref:System.Workflow.Runtime.Hosting.WorkflowPersistenceService.SaveWorkflowInstanceState%2A&gt; that specifies whether the state information of a workflow instance should be unlocked in the data store, and by providing a method &lt;xref:System.Workflow.Runtime.Hosting.WorkflowPersistenceService.UnlockWorkflowInstanceState%2A&gt; to unlock previously locked workflow state information.","pos":[1973,2502],"source":" The WorkflowPersistenceService class provides the capability to support this functionality of the workflow runtime engine by providing a parameter to <xref:System.Workflow.Runtime.Hosting.WorkflowPersistenceService.SaveWorkflowInstanceState%2A> that specifies whether the state information of a workflow instance should be unlocked in the data store, and by providing a method <xref:System.Workflow.Runtime.Hosting.WorkflowPersistenceService.UnlockWorkflowInstanceState%2A> to unlock previously locked workflow state information."},{"content":"In a persistence service that implements locking, a call to &lt;xref:System.Workflow.Runtime.Hosting.WorkflowPersistenceService.LoadWorkflowInstanceState%2A&gt; should lock the state information for a workflow instance.","pos":[2503,2716],"source":" In a persistence service that implements locking, a call to <xref:System.Workflow.Runtime.Hosting.WorkflowPersistenceService.LoadWorkflowInstanceState%2A> should lock the state information for a workflow instance."},{"content":"Your persistence service should throw a &lt;xref:System.Workflow.Runtime.Hosting.PersistenceException&gt; if it fails to save state information to its data store or load state information from its data store.","pos":[2723,2925],"source":"       Your persistence service should throw a <xref:System.Workflow.Runtime.Hosting.PersistenceException> if it fails to save state information to its data store or load state information from its data store."},{"content":"The workflow runtime engine expects this behavior.","pos":[2926,2976]},{"content":"A batching mechanism is provided for services that use a durable store to save workflow state information.","pos":[2983,3089]},{"content":"It is important in these cases to maintain consistency between the durable store that is used by the persistence service and the internal state of the workflow runtime engine.","pos":[3090,3265]},{"content":"You can add functionality defined by the &lt;xref:System.Workflow.Runtime.IPendingWork&gt; interface to your service, and then participate in workflow transaction batching provided by the &lt;xref:System.Workflow.Runtime.Hosting.WorkflowCommitWorkBatchService&gt; by adding changes to your data store as work items to the &lt;xref:System.Workflow.Runtime.WorkflowEnvironment.WorkBatch%2A&gt;.","pos":[3266,3640],"source":" You can add functionality defined by the <xref:System.Workflow.Runtime.IPendingWork> interface to your service, and then participate in workflow transaction batching provided by the <xref:System.Workflow.Runtime.Hosting.WorkflowCommitWorkBatchService> by adding changes to your data store as work items to the <xref:System.Workflow.Runtime.WorkflowEnvironment.WorkBatch%2A>."},{"content":"The durable store itself should implement the &lt;xref:System.Transactions.IEnlistmentNotification&gt; interface, so that workflow information is not persisted incorrectly in the event of a transaction rollback.","pos":[3641,3846],"source":" The durable store itself should implement the <xref:System.Transactions.IEnlistmentNotification> interface, so that workflow information is not persisted incorrectly in the event of a transaction rollback."},{"content":"For more information, see &lt;xref:System.Workflow.Runtime.Hosting.WorkflowPersistenceService.SaveCompletedContextActivity%2A&gt; or &lt;xref:System.Workflow.Runtime.Hosting.WorkflowPersistenceService.SaveWorkflowInstanceState%2A&gt;.","pos":[3847,4069],"source":" For more information, see <xref:System.Workflow.Runtime.Hosting.WorkflowPersistenceService.SaveCompletedContextActivity%2A> or <xref:System.Workflow.Runtime.Hosting.WorkflowPersistenceService.SaveWorkflowInstanceState%2A>."}]},{"pos":[7451,7608],"content":"When implemented in a derived class, initializes a new instance of the <bpt id=\"p1\">&lt;xref href=\"System.Workflow.Runtime.Hosting.WorkflowPersistenceService\"&gt;</bpt><ept id=\"p1\">&lt;/xref&gt;</ept> class.","needQuote":true,"needEscape":true,"source":"When implemented in a derived class, initializes a new instance of the <xref href=\"System.Workflow.Runtime.Hosting.WorkflowPersistenceService\"></xref> class."},{"pos":[9028,9134],"content":"Retrieves the serialized default form of the <bpt id=\"p1\">&lt;xref href=\"System.Workflow.ComponentModel.Activity\"&gt;</bpt><ept id=\"p1\">&lt;/xref&gt;</ept>.","needQuote":true,"needEscape":true,"source":"Retrieves the serialized default form of the <xref href=\"System.Workflow.ComponentModel.Activity\"></xref>."},{"pos":[9365,9465],"content":"The <bpt id=\"p1\">&lt;xref href=\"System.Workflow.ComponentModel.Activity\"&gt;</bpt><ept id=\"p1\">&lt;/xref&gt;</ept> whose serialized form is requested.","needQuote":true,"needEscape":true,"source":"The <xref href=\"System.Workflow.ComponentModel.Activity\"></xref> whose serialized form is requested."},{"pos":[9523,9619],"content":"The serialized default form of the <bpt id=\"p1\">&lt;xref href=\"System.Workflow.ComponentModel.Activity\"&gt;</bpt><ept id=\"p1\">&lt;/xref&gt;</ept>.","needQuote":true,"needEscape":true,"source":"The serialized default form of the <xref href=\"System.Workflow.ComponentModel.Activity\"></xref>."},{"pos":[10330,10378],"content":"Indicates whether the given activity is blocked.","needQuote":true,"needEscape":true,"nodes":[{"content":"Indicates whether the given activity is blocked.","pos":[0,48]}]},{"pos":[10603,10646],"content":"The root activity of the workflow instance.","needQuote":true,"needEscape":true,"nodes":[{"content":"The root activity of the workflow instance.","pos":[0,43]}]},{"pos":[10705,10874],"content":"<bpt id=\"p1\">&lt;xref uid=\"langword_csharp_true\" name=\"true\" href=\"\"&gt;</bpt><ept id=\"p1\">&lt;/xref&gt;</ept> if the given activity is blocked; otherwise, <bpt id=\"p2\">&lt;xref uid=\"langword_csharp_false\" name=\"false\" href=\"\"&gt;</bpt><ept id=\"p2\">&lt;/xref&gt;</ept>.","needQuote":true,"needEscape":true,"source":"<xref uid=\"langword_csharp_true\" name=\"true\" href=\"\"></xref> if the given activity is blocked; otherwise, <xref uid=\"langword_csharp_false\" name=\"false\" href=\"\"></xref>."},{"pos":[11638,11709],"content":"Retrieves the termination or suspend information of the given activity.","needQuote":true,"needEscape":true,"nodes":[{"content":"Retrieves the termination or suspend information of the given activity.","pos":[0,71]}]},{"pos":[11949,11992],"content":"The root activity of the workflow instance.","needQuote":true,"needEscape":true,"nodes":[{"content":"The root activity of the workflow instance.","pos":[0,43]}]},{"pos":[12050,12126],"content":"A <xref:System.String> that contains the termination or suspend information.","needQuote":true,"needEscape":true,"nodes":[{"content":"A &lt;xref:System.String&gt; that contains the termination or suspend information.","pos":[0,76],"source":"A <xref:System.String> that contains the termination or suspend information."}]},{"pos":[12863,12900],"content":"Retrieves the status of the workflow.","needQuote":true,"needEscape":true,"nodes":[{"content":"Retrieves the status of the workflow.","pos":[0,37]}]},{"pos":[13164,13207],"content":"The root activity of the workflow instance.","needQuote":true,"needEscape":true,"nodes":[{"content":"The root activity of the workflow instance.","pos":[0,43]}]},{"pos":[13290,13410],"content":"A <bpt id=\"p1\">&lt;xref href=\"System.Workflow.Runtime.WorkflowStatus\"&gt;</bpt><ept id=\"p1\">&lt;/xref&gt;</ept> enumeration value that denotes the status of the workflow.","needQuote":true,"needEscape":true,"source":"A <xref href=\"System.Workflow.Runtime.WorkflowStatus\"></xref> enumeration value that denotes the status of the workflow."},{"pos":[14233,14323],"content":"When implemented in a derived class, loads the specified completed scope back into memory.","needQuote":true,"needEscape":true,"nodes":[{"content":"When implemented in a derived class, loads the specified completed scope back into memory.","pos":[0,90]}]},{"pos":[14336,14987],"content":"The workflow runtime engine uses LoadCompletedContextActivity to implement compensation. You must restore an identical copy of the completed scope. To do this, you must restore a valid <xref:System.IO.Stream> from your representation of the completed scope in the data store. Then you must pass this <xref:System.IO.Stream> to one of the overloaded methods of <xref:System.Workflow.ComponentModel.Activity.Load%2A> to perform deserialization of the scope.       If your persistence service cannot load the completed scope from its data store, it should throw a <xref:System.Workflow.Runtime.Hosting.PersistenceException> with an appropriate message.","needQuote":false,"needEscape":true,"extradata":"MT","nodes":[{"content":"The workflow runtime engine uses LoadCompletedContextActivity to implement compensation. You must restore an identical copy of the completed scope. To do this, you must restore a valid <xref:System.IO.Stream> from your representation of the completed scope in the data store. Then you must pass this <xref:System.IO.Stream> to one of the overloaded methods of <xref:System.Workflow.ComponentModel.Activity.Load%2A> to perform deserialization of the scope.       If your persistence service cannot load the completed scope from its data store, it should throw a <xref:System.Workflow.Runtime.Hosting.PersistenceException> with an appropriate message.","pos":[0,649],"nodes":[{"content":"The workflow runtime engine uses LoadCompletedContextActivity to implement compensation.","pos":[0,88]},{"content":"You must restore an identical copy of the completed scope.","pos":[89,147]},{"content":"To do this, you must restore a valid &lt;xref:System.IO.Stream&gt; from your representation of the completed scope in the data store.","pos":[148,275],"source":" To do this, you must restore a valid <xref:System.IO.Stream> from your representation of the completed scope in the data store."},{"content":"Then you must pass this &lt;xref:System.IO.Stream&gt; to one of the overloaded methods of &lt;xref:System.Workflow.ComponentModel.Activity.Load%2A&gt; to perform deserialization of the scope.","pos":[276,455],"source":" Then you must pass this <xref:System.IO.Stream> to one of the overloaded methods of <xref:System.Workflow.ComponentModel.Activity.Load%2A> to perform deserialization of the scope."},{"content":"If your persistence service cannot load the completed scope from its data store, it should throw a &lt;xref:System.Workflow.Runtime.Hosting.PersistenceException&gt; with an appropriate message.","pos":[462,649],"source":"       If your persistence service cannot load the completed scope from its data store, it should throw a <xref:System.Workflow.Runtime.Hosting.PersistenceException> with an appropriate message."}]}]},{"pos":[15779,15825],"content":"The <xref:System.Guid> of the completed scope.","needQuote":true,"needEscape":true,"nodes":[{"content":"The &lt;xref:System.Guid&gt; of the completed scope.","pos":[0,46],"source":"The <xref:System.Guid> of the completed scope."}]},{"pos":[15921,16048],"content":"An <bpt id=\"p1\">&lt;xref href=\"System.Workflow.ComponentModel.Activity\"&gt;</bpt><ept id=\"p1\">&lt;/xref&gt;</ept> that represents the activity that encloses the completed scope.","needQuote":true,"needEscape":true,"source":"An <xref href=\"System.Workflow.ComponentModel.Activity\"></xref> that represents the activity that encloses the completed scope."},{"pos":[16132,16232],"content":"An <bpt id=\"p1\">&lt;xref href=\"System.Workflow.ComponentModel.Activity\"&gt;</bpt><ept id=\"p1\">&lt;/xref&gt;</ept> that represents the completed scope.","needQuote":true,"needEscape":true,"source":"An <xref href=\"System.Workflow.ComponentModel.Activity\"></xref> that represents the completed scope."},{"pos":[16944,17049],"content":"When implemented in a derived class, loads the specified state of the workflow instance back into memory.","needQuote":true,"needEscape":true,"nodes":[{"content":"When implemented in a derived class, loads the specified state of the workflow instance back into memory.","pos":[0,105]}]},{"pos":[17062,18768],"content":"You must restore an identical copy of the activity. To do this, you must restore a valid <xref:System.IO.Stream> from your representation of the workflow instance in the data store; then you must pass this <xref:System.IO.Stream> to one of the overloaded <xref:System.Workflow.ComponentModel.Activity.Load%2A> methods to deserialize the workflow instance state. If your persistence service cannot load the workflow instance state from its data store, it should throw a <xref:System.Workflow.Runtime.Hosting.PersistenceException> with an appropriate message.       The workflow runtime engine implements locking semantics to restrict access to a workflow instance state that is saved in a data store. This can be accessed by persistence services that run in multiple processes. The locking semantics are designed to prevent persistence services that run in two different processes from loading the same workflow instance into memory at the same time. Depending on the type of environment that your persistence service is designed to support, you may choose whether to support this functionality. If you choose to support the runtime locking semantics, and if this workflow instance state has been previously locked by another process, then you should throw a <xref:System.Workflow.Runtime.WorkflowOwnershipException>. Otherwise, you should lock access to the workflow instance state in your data store. The workflow instance state can be unlocked by a call to <xref:System.Workflow.Runtime.Hosting.WorkflowPersistenceService.UnlockWorkflowInstanceState%2A> or a call to <xref:System.Workflow.Runtime.Hosting.WorkflowPersistenceService.SaveWorkflowInstanceState%2A> with the unlock parameter set to `true`.","needQuote":false,"needEscape":true,"extradata":"MT","nodes":[{"content":"You must restore an identical copy of the activity.","pos":[0,51]},{"content":"To do this, you must restore a valid &lt;xref:System.IO.Stream&gt; from your representation of the workflow instance in the data store; then you must pass this &lt;xref:System.IO.Stream&gt; to one of the overloaded &lt;xref:System.Workflow.ComponentModel.Activity.Load%2A&gt; methods to deserialize the workflow instance state.","pos":[52,361],"source":" To do this, you must restore a valid <xref:System.IO.Stream> from your representation of the workflow instance in the data store; then you must pass this <xref:System.IO.Stream> to one of the overloaded <xref:System.Workflow.ComponentModel.Activity.Load%2A> methods to deserialize the workflow instance state."},{"content":"If your persistence service cannot load the workflow instance state from its data store, it should throw a &lt;xref:System.Workflow.Runtime.Hosting.PersistenceException&gt; with an appropriate message.","pos":[362,557],"source":" If your persistence service cannot load the workflow instance state from its data store, it should throw a <xref:System.Workflow.Runtime.Hosting.PersistenceException> with an appropriate message."},{"content":"The workflow runtime engine implements locking semantics to restrict access to a workflow instance state that is saved in a data store.","pos":[564,699]},{"content":"This can be accessed by persistence services that run in multiple processes.","pos":[700,776]},{"content":"The locking semantics are designed to prevent persistence services that run in two different processes from loading the same workflow instance into memory at the same time.","pos":[777,949]},{"content":"Depending on the type of environment that your persistence service is designed to support, you may choose whether to support this functionality.","pos":[950,1094]},{"content":"If you choose to support the runtime locking semantics, and if this workflow instance state has been previously locked by another process, then you should throw a &lt;xref:System.Workflow.Runtime.WorkflowOwnershipException&gt;.","pos":[1095,1316],"source":" If you choose to support the runtime locking semantics, and if this workflow instance state has been previously locked by another process, then you should throw a <xref:System.Workflow.Runtime.WorkflowOwnershipException>."},{"content":"Otherwise, you should lock access to the workflow instance state in your data store.","pos":[1317,1401]},{"content":"The workflow instance state can be unlocked by a call to &lt;xref:System.Workflow.Runtime.Hosting.WorkflowPersistenceService.UnlockWorkflowInstanceState%2A&gt; or a call to &lt;xref:System.Workflow.Runtime.Hosting.WorkflowPersistenceService.SaveWorkflowInstanceState%2A&gt; with the unlock parameter set to <ph id=\"ph1\">`true`</ph>.","pos":[1402,1704],"source":" The workflow instance state can be unlocked by a call to <xref:System.Workflow.Runtime.Hosting.WorkflowPersistenceService.UnlockWorkflowInstanceState%2A> or a call to <xref:System.Workflow.Runtime.Hosting.WorkflowPersistenceService.SaveWorkflowInstanceState%2A> with the unlock parameter set to `true`."}]},{"pos":[19505,19574],"content":"The <xref:System.Guid> of the root activity of the workflow instance.","needQuote":true,"needEscape":true,"nodes":[{"content":"The &lt;xref:System.Guid&gt; of the root activity of the workflow instance.","pos":[0,69],"source":"The <xref:System.Guid> of the root activity of the workflow instance."}]},{"pos":[19658,19781],"content":"An <bpt id=\"p1\">&lt;xref href=\"System.Workflow.ComponentModel.Activity\"&gt;</bpt><ept id=\"p1\">&lt;/xref&gt;</ept> that represents the root activity of the workflow instance.","needQuote":true,"needEscape":true,"source":"An <xref href=\"System.Workflow.ComponentModel.Activity\"></xref> that represents the root activity of the workflow instance."},{"pos":[20642,20741],"content":"Restores the <bpt id=\"p1\">&lt;xref href=\"System.Workflow.ComponentModel.Activity\"&gt;</bpt><ept id=\"p1\">&lt;/xref&gt;</ept> from its serialized form.","needQuote":true,"needEscape":true,"source":"Restores the <xref href=\"System.Workflow.ComponentModel.Activity\"></xref> from its serialized form."},{"pos":[21568,21652],"content":"The serialized form of <bpt id=\"p1\">&lt;xref href=\"System.Workflow.ComponentModel.Activity\"&gt;</bpt><ept id=\"p1\">&lt;/xref&gt;</ept>.","needQuote":true,"needEscape":true,"source":"The serialized form of <xref href=\"System.Workflow.ComponentModel.Activity\"></xref>."},{"pos":[21748,21907],"content":"The outer <bpt id=\"p1\">&lt;xref href=\"System.Workflow.ComponentModel.Activity\"&gt;</bpt><ept id=\"p1\">&lt;/xref&gt;</ept>, containing the <bpt id=\"p2\">&lt;xref href=\"System.Workflow.ComponentModel.Activity\"&gt;</bpt><ept id=\"p2\">&lt;/xref&gt;</ept> to restore.","needQuote":true,"needEscape":true,"source":"The outer <xref href=\"System.Workflow.ComponentModel.Activity\"></xref>, containing the <xref href=\"System.Workflow.ComponentModel.Activity\"></xref> to restore."},{"pos":[21991,22065],"content":"The restored <bpt id=\"p1\">&lt;xref href=\"System.Workflow.ComponentModel.Activity\"&gt;</bpt><ept id=\"p1\">&lt;/xref&gt;</ept>.","needQuote":true,"needEscape":true,"source":"The restored <xref href=\"System.Workflow.ComponentModel.Activity\"></xref>."},{"pos":[22864,22953],"content":"When implemented in a derived class, saves the specified completed scope to a data store.","needQuote":true,"needEscape":true,"nodes":[{"content":"When implemented in a derived class, saves the specified completed scope to a data store.","pos":[0,89]}]},{"pos":[22966,25264],"content":"The workflow runtime engine saves the state of completed scope activities in order to implement compensation. You must call one of the overloaded <xref:System.Workflow.ComponentModel.Activity.Save%2A> methods to serialize `activity` into a <xref:System.IO.Stream>; you may then choose to additionally process the <xref:System.IO.Stream> before writing it to your data store. However, when the workflow runtime engine calls <xref:System.Workflow.Runtime.Hosting.WorkflowPersistenceService.LoadCompletedContextActivity%2A>, you must restore an identical copy of the activity.       You must be able to associate the completed scope with its enclosing workflow instance to mark the scope as unneeded in your data store when the workflow instance finishes or is terminated. Therefore, you should also save the <xref:System.Guid> of the workflow instance that is associated with the completed scope; this can be obtained from the <xref:System.Workflow.Runtime.WorkflowInstance.InstanceId%2A> property of the <xref:System.Workflow.Runtime.WorkflowInstance> associated with `activity`.       <xref:System.Workflow.Runtime.Hosting.WorkflowPersistenceService.LoadCompletedContextActivity%2A> takes the <xref:System.Guid> of the completed scope as a parameter. Therefore, you must also save the <xref:System.Workflow.ComponentModel.ActivityExecutionContext.ContextGuid%2A> property associated with `activity`. This property can be referenced through the <xref:System.Workflow.ComponentModel.Activity.ActivityContextGuidProperty> field of `activity`.       If you are implementing a persistence service that uses a durable store, to maintain consistency with the internal state of the workflow runtime engine, you should participate in workflow transaction batching to defer the actual write to your durable store until a workflow commit point. To participate in batching, add a work item to the <xref:System.Workflow.Runtime.WorkflowEnvironment.WorkBatch%2A> property that represents the pending changes to the database, and implement the <xref:System.Workflow.Runtime.IPendingWork> interface in your persistence service.       If you cannot save the completed scope to your data store, you should throw a <xref:System.Workflow.Runtime.Hosting.PersistenceException> with an appropriate error message.","needQuote":false,"needEscape":true,"extradata":"MT","nodes":[{"content":"The workflow runtime engine saves the state of completed scope activities in order to implement compensation.","pos":[0,109]},{"content":"You must call one of the overloaded &lt;xref:System.Workflow.ComponentModel.Activity.Save%2A&gt; methods to serialize <ph id=\"ph1\">`activity`</ph> into a &lt;xref:System.IO.Stream&gt;; you may then choose to additionally process the &lt;xref:System.IO.Stream&gt; before writing it to your data store.","pos":[110,374],"source":" You must call one of the overloaded <xref:System.Workflow.ComponentModel.Activity.Save%2A> methods to serialize `activity` into a <xref:System.IO.Stream>; you may then choose to additionally process the <xref:System.IO.Stream> before writing it to your data store."},{"content":"However, when the workflow runtime engine calls &lt;xref:System.Workflow.Runtime.Hosting.WorkflowPersistenceService.LoadCompletedContextActivity%2A&gt;, you must restore an identical copy of the activity.","pos":[375,573],"source":" However, when the workflow runtime engine calls <xref:System.Workflow.Runtime.Hosting.WorkflowPersistenceService.LoadCompletedContextActivity%2A>, you must restore an identical copy of the activity."},{"content":"You must be able to associate the completed scope with its enclosing workflow instance to mark the scope as unneeded in your data store when the workflow instance finishes or is terminated.","pos":[580,769]},{"content":"Therefore, you should also save the &lt;xref:System.Guid&gt; of the workflow instance that is associated with the completed scope; this can be obtained from the &lt;xref:System.Workflow.Runtime.WorkflowInstance.InstanceId%2A&gt; property of the &lt;xref:System.Workflow.Runtime.WorkflowInstance&gt; associated with <ph id=\"ph1\">`activity`</ph>.","pos":[770,1078],"source":" Therefore, you should also save the <xref:System.Guid> of the workflow instance that is associated with the completed scope; this can be obtained from the <xref:System.Workflow.Runtime.WorkflowInstance.InstanceId%2A> property of the <xref:System.Workflow.Runtime.WorkflowInstance> associated with `activity`."},{"content":"&lt;xref:System.Workflow.Runtime.Hosting.WorkflowPersistenceService.LoadCompletedContextActivity%2A&gt; takes the &lt;xref:System.Guid&gt; of the completed scope as a parameter.","pos":[1085,1250],"source":"       <xref:System.Workflow.Runtime.Hosting.WorkflowPersistenceService.LoadCompletedContextActivity%2A> takes the <xref:System.Guid> of the completed scope as a parameter."},{"content":"Therefore, you must also save the &lt;xref:System.Workflow.ComponentModel.ActivityExecutionContext.ContextGuid%2A&gt; property associated with <ph id=\"ph1\">`activity`</ph>.","pos":[1251,1399],"source":" Therefore, you must also save the <xref:System.Workflow.ComponentModel.ActivityExecutionContext.ContextGuid%2A> property associated with `activity`."},{"content":"This property can be referenced through the &lt;xref:System.Workflow.ComponentModel.Activity.ActivityContextGuidProperty&gt; field of <ph id=\"ph1\">`activity`</ph>.","pos":[1400,1539],"source":" This property can be referenced through the <xref:System.Workflow.ComponentModel.Activity.ActivityContextGuidProperty> field of `activity`."},{"content":"If you are implementing a persistence service that uses a durable store, to maintain consistency with the internal state of the workflow runtime engine, you should participate in workflow transaction batching to defer the actual write to your durable store until a workflow commit point.","pos":[1546,1833]},{"content":"To participate in batching, add a work item to the &lt;xref:System.Workflow.Runtime.WorkflowEnvironment.WorkBatch%2A&gt; property that represents the pending changes to the database, and implement the &lt;xref:System.Workflow.Runtime.IPendingWork&gt; interface in your persistence service.","pos":[1834,2111],"source":" To participate in batching, add a work item to the <xref:System.Workflow.Runtime.WorkflowEnvironment.WorkBatch%2A> property that represents the pending changes to the database, and implement the <xref:System.Workflow.Runtime.IPendingWork> interface in your persistence service."},{"content":"If you cannot save the completed scope to your data store, you should throw a &lt;xref:System.Workflow.Runtime.Hosting.PersistenceException&gt; with an appropriate error message.","pos":[2118,2290],"source":"       If you cannot save the completed scope to your data store, you should throw a <xref:System.Workflow.Runtime.Hosting.PersistenceException> with an appropriate error message."}]},{"pos":[26031,26131],"content":"An <bpt id=\"p1\">&lt;xref href=\"System.Workflow.ComponentModel.Activity\"&gt;</bpt><ept id=\"p1\">&lt;/xref&gt;</ept> that represents the completed scope.","needQuote":true,"needEscape":true,"source":"An <xref href=\"System.Workflow.ComponentModel.Activity\"></xref> that represents the completed scope."},{"pos":[26965,27052],"content":"When implemented in a derived class, saves the workflow instance state to a data store.","needQuote":true,"needEscape":true,"nodes":[{"content":"When implemented in a derived class, saves the workflow instance state to a data store.","pos":[0,87]}]},{"pos":[27065,30520],"content":"You must call one of the overloaded <xref:System.Workflow.ComponentModel.Activity.Save%2A> methods to serialize `rootActivity` into a <xref:System.IO.Stream>. You can then choose to additionally process the <xref:System.IO.Stream> before writing it to your data store. However, when the workflow runtime engine calls <xref:System.Workflow.Runtime.Hosting.WorkflowPersistenceService.LoadWorkflowInstanceState%2A>, you must restore an identical copy of the root activity. If you cannot save the workflow instance state to your data store, you should throw a <xref:System.Workflow.Runtime.Hosting.PersistenceException> with an appropriate error message.       The workflow runtime engine provides locking semantics to restrict access to a workflow instance state that is saved in the data store. This can be accessed by the persistence services running in multiple hosts and pointing to the same data store. The locking semantics are designed to prevent persistence services that run in two different workflow runtimes from loading the same workflow instance into memory at the same time. Depending on the type of environment your persistence service is designed to support, you can choose whether to support this functionality. If you choose to support the runtime locking semantics, then, if a persistence service tries to save a workflow instance state that has been previously locked by another persistence service, you should throw a <xref:System.Workflow.Runtime.WorkflowOwnershipException>. If `unlock` is `true`, you should unlock access to the workflow instance state after you save it.       <xref:System.Workflow.Runtime.Hosting.WorkflowPersistenceService.LoadWorkflowInstanceState%2A> takes the <xref:System.Guid> of the workflow instance as a parameter. Therefore, you should save this <xref:System.Guid>. You can also use this <xref:System.Guid> to associate the workflow instance with the saved states of its completed scopes. You must do this because you must be able to mark these completed scopes as unneeded when the workflow instance completes.       The workflow runtime engine calls SaveWorkflowInstanceState a final time when the workflow instance is completed or terminated. Therefore, if <xref:System.Workflow.Runtime.Hosting.WorkflowPersistenceService.GetWorkflowStatus%2A> is equal to <xref:System.Workflow.Runtime.WorkflowStatus> or <xref:System.Workflow.Runtime.WorkflowStatus>, you can safely delete the workflow instance and all its associated completed scopes from your data store. Alternatively, you can subscribe to the <xref:System.Workflow.Runtime.WorkflowRuntime.WorkflowCompleted> or <xref:System.Workflow.Runtime.WorkflowRuntime.WorkflowTerminated> events to determine when it is safe to delete records associated with the workflow instance. Whether you actually delete the records from your data store depends on your implementation.       If you implement a persistence service that uses a durable store, then, to maintain consistency with the internal state of the workflow runtime engine, you should participate in workflow transaction batching to defer the actual write to your durable store until a workflow commit point. To participate in batching, add a work item that represents the pending changes to your durable store to the <xref:System.Workflow.Runtime.WorkflowEnvironment.WorkBatch%2A> property, and implement the <xref:System.Workflow.Runtime.IPendingWork> interface in your persistence service.","needQuote":false,"needEscape":true,"extradata":"MT","nodes":[{"content":"You must call one of the overloaded &lt;xref:System.Workflow.ComponentModel.Activity.Save%2A&gt; methods to serialize <ph id=\"ph1\">`rootActivity`</ph> into a &lt;xref:System.IO.Stream&gt;.","pos":[0,158],"source":"You must call one of the overloaded <xref:System.Workflow.ComponentModel.Activity.Save%2A> methods to serialize `rootActivity` into a <xref:System.IO.Stream>."},{"content":"You can then choose to additionally process the &lt;xref:System.IO.Stream&gt; before writing it to your data store.","pos":[159,268],"source":" You can then choose to additionally process the <xref:System.IO.Stream> before writing it to your data store."},{"content":"However, when the workflow runtime engine calls &lt;xref:System.Workflow.Runtime.Hosting.WorkflowPersistenceService.LoadWorkflowInstanceState%2A&gt;, you must restore an identical copy of the root activity.","pos":[269,469],"source":" However, when the workflow runtime engine calls <xref:System.Workflow.Runtime.Hosting.WorkflowPersistenceService.LoadWorkflowInstanceState%2A>, you must restore an identical copy of the root activity."},{"content":"If you cannot save the workflow instance state to your data store, you should throw a &lt;xref:System.Workflow.Runtime.Hosting.PersistenceException&gt; with an appropriate error message.","pos":[470,650],"source":" If you cannot save the workflow instance state to your data store, you should throw a <xref:System.Workflow.Runtime.Hosting.PersistenceException> with an appropriate error message."},{"content":"The workflow runtime engine provides locking semantics to restrict access to a workflow instance state that is saved in the data store.","pos":[657,792]},{"content":"This can be accessed by the persistence services running in multiple hosts and pointing to the same data store.","pos":[793,904]},{"content":"The locking semantics are designed to prevent persistence services that run in two different workflow runtimes from loading the same workflow instance into memory at the same time.","pos":[905,1085]},{"content":"Depending on the type of environment your persistence service is designed to support, you can choose whether to support this functionality.","pos":[1086,1225]},{"content":"If you choose to support the runtime locking semantics, then, if a persistence service tries to save a workflow instance state that has been previously locked by another persistence service, you should throw a &lt;xref:System.Workflow.Runtime.WorkflowOwnershipException&gt;.","pos":[1226,1494],"source":" If you choose to support the runtime locking semantics, then, if a persistence service tries to save a workflow instance state that has been previously locked by another persistence service, you should throw a <xref:System.Workflow.Runtime.WorkflowOwnershipException>."},{"content":"If <ph id=\"ph1\">`unlock`</ph> is <ph id=\"ph2\">`true`</ph>, you should unlock access to the workflow instance state after you save it.","pos":[1495,1592],"source":" If `unlock` is `true`, you should unlock access to the workflow instance state after you save it."},{"content":"&lt;xref:System.Workflow.Runtime.Hosting.WorkflowPersistenceService.LoadWorkflowInstanceState%2A&gt; takes the &lt;xref:System.Guid&gt; of the workflow instance as a parameter.","pos":[1599,1763],"source":"       <xref:System.Workflow.Runtime.Hosting.WorkflowPersistenceService.LoadWorkflowInstanceState%2A> takes the <xref:System.Guid> of the workflow instance as a parameter."},{"content":"Therefore, you should save this &lt;xref:System.Guid&gt;.","pos":[1764,1815],"source":" Therefore, you should save this <xref:System.Guid>."},{"content":"You can also use this &lt;xref:System.Guid&gt; to associate the workflow instance with the saved states of its completed scopes.","pos":[1816,1938],"source":" You can also use this <xref:System.Guid> to associate the workflow instance with the saved states of its completed scopes."},{"content":"You must do this because you must be able to mark these completed scopes as unneeded when the workflow instance completes.","pos":[1939,2061]},{"content":"The workflow runtime engine calls SaveWorkflowInstanceState a final time when the workflow instance is completed or terminated.","pos":[2068,2195]},{"content":"Therefore, if &lt;xref:System.Workflow.Runtime.Hosting.WorkflowPersistenceService.GetWorkflowStatus%2A&gt; is equal to &lt;xref:System.Workflow.Runtime.WorkflowStatus&gt; or &lt;xref:System.Workflow.Runtime.WorkflowStatus&gt;, you can safely delete the workflow instance and all its associated completed scopes from your data store.","pos":[2196,2510],"source":" Therefore, if <xref:System.Workflow.Runtime.Hosting.WorkflowPersistenceService.GetWorkflowStatus%2A> is equal to <xref:System.Workflow.Runtime.WorkflowStatus> or <xref:System.Workflow.Runtime.WorkflowStatus>, you can safely delete the workflow instance and all its associated completed scopes from your data store."},{"content":"Alternatively, you can subscribe to the &lt;xref:System.Workflow.Runtime.WorkflowRuntime.WorkflowCompleted&gt; or &lt;xref:System.Workflow.Runtime.WorkflowRuntime.WorkflowTerminated&gt; events to determine when it is safe to delete records associated with the workflow instance.","pos":[2511,2777],"source":" Alternatively, you can subscribe to the <xref:System.Workflow.Runtime.WorkflowRuntime.WorkflowCompleted> or <xref:System.Workflow.Runtime.WorkflowRuntime.WorkflowTerminated> events to determine when it is safe to delete records associated with the workflow instance."},{"content":"Whether you actually delete the records from your data store depends on your implementation.","pos":[2778,2870]},{"content":"If you implement a persistence service that uses a durable store, then, to maintain consistency with the internal state of the workflow runtime engine, you should participate in workflow transaction batching to defer the actual write to your durable store until a workflow commit point.","pos":[2877,3163]},{"content":"To participate in batching, add a work item that represents the pending changes to your durable store to the &lt;xref:System.Workflow.Runtime.WorkflowEnvironment.WorkBatch%2A&gt; property, and implement the &lt;xref:System.Workflow.Runtime.IPendingWork&gt; interface in your persistence service.","pos":[3164,3447],"source":" To participate in batching, add a work item that represents the pending changes to your durable store to the <xref:System.Workflow.Runtime.WorkflowEnvironment.WorkBatch%2A> property, and implement the <xref:System.Workflow.Runtime.IPendingWork> interface in your persistence service."}]},{"pos":[31302,31345],"content":"The root activity of the workflow instance.","needQuote":true,"needEscape":true,"nodes":[{"content":"The root activity of the workflow instance.","pos":[0,43]}]},{"pos":[31409,31622],"content":"<bpt id=\"p1\">&lt;xref uid=\"langword_csharp_true\" name=\"true\" href=\"\"&gt;</bpt><ept id=\"p1\">&lt;/xref&gt;</ept> if the workflow instance should not be locked; <bpt id=\"p2\">&lt;xref uid=\"langword_csharp_false\" name=\"false\" href=\"\"&gt;</bpt><ept id=\"p2\">&lt;/xref&gt;</ept> if the workflow instance should be locked.","needQuote":true,"needEscape":true,"source":"<xref uid=\"langword_csharp_true\" name=\"true\" href=\"\"></xref> if the workflow instance should not be locked; <xref uid=\"langword_csharp_false\" name=\"false\" href=\"\"></xref> if the workflow instance should be locked."},{"pos":[32334,32393],"content":"Determines whether a workflow should be unloaded when idle.","needQuote":true,"needEscape":true,"nodes":[{"content":"Determines whether a workflow should be unloaded when idle.","pos":[0,59]}]},{"pos":[33141,33241],"content":"An <bpt id=\"p1\">&lt;xref href=\"System.Workflow.ComponentModel.Activity\"&gt;</bpt><ept id=\"p1\">&lt;/xref&gt;</ept> that represents the completed scope.","needQuote":true,"needEscape":true,"source":"An <xref href=\"System.Workflow.ComponentModel.Activity\"></xref> that represents the completed scope."},{"pos":[33300,33445],"content":"If <bpt id=\"p1\">&lt;xref uid=\"langword_csharp_true\" name=\"true\" href=\"\"&gt;</bpt><ept id=\"p1\">&lt;/xref&gt;</ept>, the workflow runtime engine unloads the specified workflow when it becomes idle.","needQuote":true,"needEscape":true,"source":"If <xref uid=\"langword_csharp_true\" name=\"true\" href=\"\"></xref>, the workflow runtime engine unloads the specified workflow when it becomes idle."},{"pos":[34219,34291],"content":"When overridden in a derived class, unlocks the workflow instance state.","needQuote":true,"needEscape":true,"nodes":[{"content":"When overridden in a derived class, unlocks the workflow instance state.","pos":[0,72]}]},{"pos":[34304,34734],"content":"This method is abstract, so it does not contain a default implementation on locking and unlocking.       While implementing a custom persistence service, if you want to implement a locking scheme you will need to override this method and provide a locking-unlocking mechanism in the <xref:System.Workflow.Runtime.Hosting.WorkflowPersistenceService.SaveWorkflowInstanceState%2A> method based on the value of the unlock parameter.","needQuote":false,"needEscape":true,"extradata":"MT","nodes":[{"content":"This method is abstract, so it does not contain a default implementation on locking and unlocking.       While implementing a custom persistence service, if you want to implement a locking scheme you will need to override this method and provide a locking-unlocking mechanism in the <xref:System.Workflow.Runtime.Hosting.WorkflowPersistenceService.SaveWorkflowInstanceState%2A> method based on the value of the unlock parameter.","pos":[0,428],"nodes":[{"content":"This method is abstract, so it does not contain a default implementation on locking and unlocking.","pos":[0,98]},{"content":"While implementing a custom persistence service, if you want to implement a locking scheme you will need to override this method and provide a locking-unlocking mechanism in the &lt;xref:System.Workflow.Runtime.Hosting.WorkflowPersistenceService.SaveWorkflowInstanceState%2A&gt; method based on the value of the unlock parameter.","pos":[105,428],"source":"       While implementing a custom persistence service, if you want to implement a locking scheme you will need to override this method and provide a locking-unlocking mechanism in the <xref:System.Workflow.Runtime.Hosting.WorkflowPersistenceService.SaveWorkflowInstanceState%2A> method based on the value of the unlock parameter."}]}]},{"pos":[35507,35550],"content":"The root activity of the workflow instance.","needQuote":true,"needEscape":true,"nodes":[{"content":"The root activity of the workflow instance.","pos":[0,43]}]}],"content":"### YamlMime:ManagedReference\nitems:\n- uid: System.Workflow.Runtime.Hosting.WorkflowPersistenceService\n  id: WorkflowPersistenceService\n  children:\n  - System.Workflow.Runtime.Hosting.WorkflowPersistenceService.#ctor\n  - System.Workflow.Runtime.Hosting.WorkflowPersistenceService.GetDefaultSerializedForm(System.Workflow.ComponentModel.Activity)\n  - System.Workflow.Runtime.Hosting.WorkflowPersistenceService.GetIsBlocked(System.Workflow.ComponentModel.Activity)\n  - System.Workflow.Runtime.Hosting.WorkflowPersistenceService.GetSuspendOrTerminateInfo(System.Workflow.ComponentModel.Activity)\n  - System.Workflow.Runtime.Hosting.WorkflowPersistenceService.GetWorkflowStatus(System.Workflow.ComponentModel.Activity)\n  - System.Workflow.Runtime.Hosting.WorkflowPersistenceService.LoadCompletedContextActivity(System.Guid,System.Workflow.ComponentModel.Activity)\n  - System.Workflow.Runtime.Hosting.WorkflowPersistenceService.LoadWorkflowInstanceState(System.Guid)\n  - System.Workflow.Runtime.Hosting.WorkflowPersistenceService.RestoreFromDefaultSerializedForm(System.Byte[],System.Workflow.ComponentModel.Activity)\n  - System.Workflow.Runtime.Hosting.WorkflowPersistenceService.SaveCompletedContextActivity(System.Workflow.ComponentModel.Activity)\n  - System.Workflow.Runtime.Hosting.WorkflowPersistenceService.SaveWorkflowInstanceState(System.Workflow.ComponentModel.Activity,System.Boolean)\n  - System.Workflow.Runtime.Hosting.WorkflowPersistenceService.UnloadOnIdle(System.Workflow.ComponentModel.Activity)\n  - System.Workflow.Runtime.Hosting.WorkflowPersistenceService.UnlockWorkflowInstanceState(System.Workflow.ComponentModel.Activity)\n  langs:\n  - csharp\n  name: WorkflowPersistenceService\n  nameWithType: WorkflowPersistenceService\n  fullName: System.Workflow.Runtime.Hosting.WorkflowPersistenceService\n  type: Class\n  summary: The abstract base class from which all persistence services are derived.\n  remarks: \"> [!NOTE]\\n>  [!INCLUDE[DeprecatedContent](~/add/includes/ajax-current-ext-md.md)]  \\n  \\n When certain conditions occur while the workflow is running, the workflow runtime engine persists state information about the workflow instance. Persistence can occur, for example, when an atomic transaction finishes, when the workflow instance becomes idle, when the host calls <xref:System.Workflow.Runtime.WorkflowInstance.Unload%2A?displayProperty=fullName> on the workflow instance, or when a workflow instance is terminated or finishes. When the workflow runtime engine semantics dictate that persistence should occur, the workflow runtime engine calls methods that are supplied by a persistence service to save state information about the workflow instance. Likewise, when the workflow runtime engine needs to restore a previously persisted workflow instance, it calls methods that are supplied by the persistence service to load this state information. The workflow runtime engine handles all the semantics regarding when to perform persistence. The persistence service handles actually saving and loading the workflow state information to or from a data store.  \\n  \\n You can create a persistence service by deriving a class from the WorkflowPersistenceService class.  You can add your persistence service to the workflow runtime engine by calling <xref:System.Workflow.Runtime.WorkflowRuntime.AddService%2A> or by making an appropriate entry in the application configuration file. The <xref:System.Workflow.Runtime.WorkflowRuntime> should only contain one persistence service. Windows Workflow Foundation provides the <xref:System.Workflow.Runtime.Hosting.SqlWorkflowPersistenceService> class, an out-of-box persistence service, which you can use as is or extend.  \\n  \\n The workflow runtime engine has semantics for locking workflow state information for use in environments where persistence services that run in different processes might have access to a single data store. The WorkflowPersistenceService class provides the capability to support this functionality of the workflow runtime engine by providing a parameter to <xref:System.Workflow.Runtime.Hosting.WorkflowPersistenceService.SaveWorkflowInstanceState%2A> that specifies whether the state information of a workflow instance should be unlocked in the data store, and by providing a method <xref:System.Workflow.Runtime.Hosting.WorkflowPersistenceService.UnlockWorkflowInstanceState%2A> to unlock previously locked workflow state information. In a persistence service that implements locking, a call to <xref:System.Workflow.Runtime.Hosting.WorkflowPersistenceService.LoadWorkflowInstanceState%2A> should lock the state information for a workflow instance.  \\n  \\n Your persistence service should throw a <xref:System.Workflow.Runtime.Hosting.PersistenceException> if it fails to save state information to its data store or load state information from its data store. The workflow runtime engine expects this behavior.  \\n  \\n A batching mechanism is provided for services that use a durable store to save workflow state information. It is important in these cases to maintain consistency between the durable store that is used by the persistence service and the internal state of the workflow runtime engine. You can add functionality defined by the <xref:System.Workflow.Runtime.IPendingWork> interface to your service, and then participate in workflow transaction batching provided by the <xref:System.Workflow.Runtime.Hosting.WorkflowCommitWorkBatchService> by adding changes to your data store as work items to the <xref:System.Workflow.Runtime.WorkflowEnvironment.WorkBatch%2A>. The durable store itself should implement the <xref:System.Transactions.IEnlistmentNotification> interface, so that workflow information is not persisted incorrectly in the event of a transaction rollback. For more information, see <xref:System.Workflow.Runtime.Hosting.WorkflowPersistenceService.SaveCompletedContextActivity%2A> or <xref:System.Workflow.Runtime.Hosting.WorkflowPersistenceService.SaveWorkflowInstanceState%2A>.\"\n  syntax:\n    content: >-\n      [System.Obsolete(\"The System.Workflow.* types are deprecated.  Instead, please use the new types from System.Activities.*\")]\n\n      public abstract class WorkflowPersistenceService : System.Workflow.Runtime.Hosting.WorkflowRuntimeService\n  inheritance:\n  - System.Object\n  - System.Workflow.Runtime.Hosting.WorkflowRuntimeService\n  implements: []\n  inheritedMembers:\n  - System.Workflow.Runtime.Hosting.WorkflowRuntimeService.OnStarted\n  - System.Workflow.Runtime.Hosting.WorkflowRuntimeService.OnStopped\n  - System.Workflow.Runtime.Hosting.WorkflowRuntimeService.RaiseServicesExceptionNotHandledEvent(System.Exception,System.Guid)\n  - System.Workflow.Runtime.Hosting.WorkflowRuntimeService.Runtime\n  - System.Workflow.Runtime.Hosting.WorkflowRuntimeService.Start\n  - System.Workflow.Runtime.Hosting.WorkflowRuntimeService.State\n  - System.Workflow.Runtime.Hosting.WorkflowRuntimeService.Stop\n  platform:\n  - net462\n- uid: System.Workflow.Runtime.Hosting.WorkflowPersistenceService.#ctor\n  id: '#ctor'\n  parent: System.Workflow.Runtime.Hosting.WorkflowPersistenceService\n  langs:\n  - csharp\n  name: WorkflowPersistenceService()\n  nameWithType: WorkflowPersistenceService.WorkflowPersistenceService()\n  fullName: System.Workflow.Runtime.Hosting.WorkflowPersistenceService.WorkflowPersistenceService()\n  type: Constructor\n  assemblies:\n  - System.Workflow.Runtime\n  namespace: System.Workflow.Runtime.Hosting\n  summary: When implemented in a derived class, initializes a new instance of the <xref href=\"System.Workflow.Runtime.Hosting.WorkflowPersistenceService\"></xref> class.\n  remarks: ''\n  example:\n  - \"The following example demonstrates creating an instance of the `SqlWorkflowPersistenceService` class (derived from `WorkflowPersistenceService`). This example is from the Nested Exception Handlers SDK sample, from the Program.cs class.  For more information, see the [Nested Exception Handlers Sample](http://msdn.microsoft.com/en-us/d1da0209-842b-41c8-9b7c-0cbaa1034265).  \\n  \\n [!code-cs[WF_Samples#161](~/add/codesnippet/csharp/wf_snippets/snippets11.cs#161)]\\n [!code-vb[WF_Samples#161](~/add/codesnippet/visualbasic/wf_snippets/snippets11.vb#161)]\"\n  syntax:\n    content: protected WorkflowPersistenceService ();\n    parameters: []\n  overload: System.Workflow.Runtime.Hosting.WorkflowPersistenceService.#ctor*\n  exceptions: []\n  platform:\n  - net462\n- uid: System.Workflow.Runtime.Hosting.WorkflowPersistenceService.GetDefaultSerializedForm(System.Workflow.ComponentModel.Activity)\n  id: GetDefaultSerializedForm(System.Workflow.ComponentModel.Activity)\n  parent: System.Workflow.Runtime.Hosting.WorkflowPersistenceService\n  langs:\n  - csharp\n  name: GetDefaultSerializedForm(Activity)\n  nameWithType: WorkflowPersistenceService.GetDefaultSerializedForm(Activity)\n  fullName: System.Workflow.Runtime.Hosting.WorkflowPersistenceService.GetDefaultSerializedForm(Activity)\n  type: Method\n  assemblies:\n  - System.Workflow.Runtime\n  namespace: System.Workflow.Runtime.Hosting\n  summary: Retrieves the serialized default form of the <xref href=\"System.Workflow.ComponentModel.Activity\"></xref>.\n  syntax:\n    content: protected static byte[] GetDefaultSerializedForm (System.Workflow.ComponentModel.Activity activity);\n    parameters:\n    - id: activity\n      type: System.Workflow.ComponentModel.Activity\n      description: The <xref href=\"System.Workflow.ComponentModel.Activity\"></xref> whose serialized form is requested.\n    return:\n      type: System.Byte[]\n      description: The serialized default form of the <xref href=\"System.Workflow.ComponentModel.Activity\"></xref>.\n  overload: System.Workflow.Runtime.Hosting.WorkflowPersistenceService.GetDefaultSerializedForm*\n  exceptions: []\n  platform:\n  - net462\n- uid: System.Workflow.Runtime.Hosting.WorkflowPersistenceService.GetIsBlocked(System.Workflow.ComponentModel.Activity)\n  id: GetIsBlocked(System.Workflow.ComponentModel.Activity)\n  parent: System.Workflow.Runtime.Hosting.WorkflowPersistenceService\n  langs:\n  - csharp\n  name: GetIsBlocked(Activity)\n  nameWithType: WorkflowPersistenceService.GetIsBlocked(Activity)\n  fullName: System.Workflow.Runtime.Hosting.WorkflowPersistenceService.GetIsBlocked(Activity)\n  type: Method\n  assemblies:\n  - System.Workflow.Runtime\n  namespace: System.Workflow.Runtime.Hosting\n  summary: Indicates whether the given activity is blocked.\n  syntax:\n    content: protected static bool GetIsBlocked (System.Workflow.ComponentModel.Activity rootActivity);\n    parameters:\n    - id: rootActivity\n      type: System.Workflow.ComponentModel.Activity\n      description: The root activity of the workflow instance.\n    return:\n      type: System.Boolean\n      description: <xref uid=\"langword_csharp_true\" name=\"true\" href=\"\"></xref> if the given activity is blocked; otherwise, <xref uid=\"langword_csharp_false\" name=\"false\" href=\"\"></xref>.\n  overload: System.Workflow.Runtime.Hosting.WorkflowPersistenceService.GetIsBlocked*\n  exceptions: []\n  platform:\n  - net462\n- uid: System.Workflow.Runtime.Hosting.WorkflowPersistenceService.GetSuspendOrTerminateInfo(System.Workflow.ComponentModel.Activity)\n  id: GetSuspendOrTerminateInfo(System.Workflow.ComponentModel.Activity)\n  parent: System.Workflow.Runtime.Hosting.WorkflowPersistenceService\n  langs:\n  - csharp\n  name: GetSuspendOrTerminateInfo(Activity)\n  nameWithType: WorkflowPersistenceService.GetSuspendOrTerminateInfo(Activity)\n  fullName: System.Workflow.Runtime.Hosting.WorkflowPersistenceService.GetSuspendOrTerminateInfo(Activity)\n  type: Method\n  assemblies:\n  - System.Workflow.Runtime\n  namespace: System.Workflow.Runtime.Hosting\n  summary: Retrieves the termination or suspend information of the given activity.\n  syntax:\n    content: protected static string GetSuspendOrTerminateInfo (System.Workflow.ComponentModel.Activity rootActivity);\n    parameters:\n    - id: rootActivity\n      type: System.Workflow.ComponentModel.Activity\n      description: The root activity of the workflow instance.\n    return:\n      type: System.String\n      description: A <xref:System.String> that contains the termination or suspend information.\n  overload: System.Workflow.Runtime.Hosting.WorkflowPersistenceService.GetSuspendOrTerminateInfo*\n  exceptions: []\n  platform:\n  - net462\n- uid: System.Workflow.Runtime.Hosting.WorkflowPersistenceService.GetWorkflowStatus(System.Workflow.ComponentModel.Activity)\n  id: GetWorkflowStatus(System.Workflow.ComponentModel.Activity)\n  parent: System.Workflow.Runtime.Hosting.WorkflowPersistenceService\n  langs:\n  - csharp\n  name: GetWorkflowStatus(Activity)\n  nameWithType: WorkflowPersistenceService.GetWorkflowStatus(Activity)\n  fullName: System.Workflow.Runtime.Hosting.WorkflowPersistenceService.GetWorkflowStatus(Activity)\n  type: Method\n  assemblies:\n  - System.Workflow.Runtime\n  namespace: System.Workflow.Runtime.Hosting\n  summary: Retrieves the status of the workflow.\n  syntax:\n    content: protected static System.Workflow.Runtime.WorkflowStatus GetWorkflowStatus (System.Workflow.ComponentModel.Activity rootActivity);\n    parameters:\n    - id: rootActivity\n      type: System.Workflow.ComponentModel.Activity\n      description: The root activity of the workflow instance.\n    return:\n      type: System.Workflow.Runtime.WorkflowStatus\n      description: A <xref href=\"System.Workflow.Runtime.WorkflowStatus\"></xref> enumeration value that denotes the status of the workflow.\n  overload: System.Workflow.Runtime.Hosting.WorkflowPersistenceService.GetWorkflowStatus*\n  exceptions: []\n  platform:\n  - net462\n- uid: System.Workflow.Runtime.Hosting.WorkflowPersistenceService.LoadCompletedContextActivity(System.Guid,System.Workflow.ComponentModel.Activity)\n  id: LoadCompletedContextActivity(System.Guid,System.Workflow.ComponentModel.Activity)\n  parent: System.Workflow.Runtime.Hosting.WorkflowPersistenceService\n  langs:\n  - csharp\n  name: LoadCompletedContextActivity(Guid,Activity)\n  nameWithType: WorkflowPersistenceService.LoadCompletedContextActivity(Guid,Activity)\n  fullName: System.Workflow.Runtime.Hosting.WorkflowPersistenceService.LoadCompletedContextActivity(Guid,Activity)\n  type: Method\n  assemblies:\n  - System.Workflow.Runtime\n  namespace: System.Workflow.Runtime.Hosting\n  summary: When implemented in a derived class, loads the specified completed scope back into memory.\n  remarks: \"The workflow runtime engine uses LoadCompletedContextActivity to implement compensation. You must restore an identical copy of the completed scope. To do this, you must restore a valid <xref:System.IO.Stream> from your representation of the completed scope in the data store. Then you must pass this <xref:System.IO.Stream> to one of the overloaded methods of <xref:System.Workflow.ComponentModel.Activity.Load%2A> to perform deserialization of the scope.  \\n  \\n If your persistence service cannot load the completed scope from its data store, it should throw a <xref:System.Workflow.Runtime.Hosting.PersistenceException> with an appropriate message.\"\n  example:\n  - \"The following example demonstrates an implementation of the `LoadCompletedContextActivity` method. This example is from the Custom Persistence Service sample, from the FilePersistenceService.cs file. For more information, see [Custom Persistence Service Sample](http://msdn.microsoft.com/en-us/869dfadf-5298-4551-bc80-f4cf7918729d).  \\n  \\n [!code-cs[WF_Samples#269](~/add/codesnippet/csharp/wf_snippets/snippets24.cs#269)]\\n [!code-vb[WF_Samples#269](~/add/codesnippet/visualbasic/wf_snippets/snippets24.vb#269)]\"\n  syntax:\n    content: protected abstract System.Workflow.ComponentModel.Activity LoadCompletedContextActivity (Guid scopeId, System.Workflow.ComponentModel.Activity outerActivity);\n    parameters:\n    - id: scopeId\n      type: System.Guid\n      description: The <xref:System.Guid> of the completed scope.\n    - id: outerActivity\n      type: System.Workflow.ComponentModel.Activity\n      description: An <xref href=\"System.Workflow.ComponentModel.Activity\"></xref> that represents the activity that encloses the completed scope.\n    return:\n      type: System.Workflow.ComponentModel.Activity\n      description: An <xref href=\"System.Workflow.ComponentModel.Activity\"></xref> that represents the completed scope.\n  overload: System.Workflow.Runtime.Hosting.WorkflowPersistenceService.LoadCompletedContextActivity*\n  exceptions: []\n  platform:\n  - net462\n- uid: System.Workflow.Runtime.Hosting.WorkflowPersistenceService.LoadWorkflowInstanceState(System.Guid)\n  id: LoadWorkflowInstanceState(System.Guid)\n  parent: System.Workflow.Runtime.Hosting.WorkflowPersistenceService\n  langs:\n  - csharp\n  name: LoadWorkflowInstanceState(Guid)\n  nameWithType: WorkflowPersistenceService.LoadWorkflowInstanceState(Guid)\n  fullName: System.Workflow.Runtime.Hosting.WorkflowPersistenceService.LoadWorkflowInstanceState(Guid)\n  type: Method\n  assemblies:\n  - System.Workflow.Runtime\n  namespace: System.Workflow.Runtime.Hosting\n  summary: When implemented in a derived class, loads the specified state of the workflow instance back into memory.\n  remarks: \"You must restore an identical copy of the activity. To do this, you must restore a valid <xref:System.IO.Stream> from your representation of the workflow instance in the data store; then you must pass this <xref:System.IO.Stream> to one of the overloaded <xref:System.Workflow.ComponentModel.Activity.Load%2A> methods to deserialize the workflow instance state. If your persistence service cannot load the workflow instance state from its data store, it should throw a <xref:System.Workflow.Runtime.Hosting.PersistenceException> with an appropriate message.  \\n  \\n The workflow runtime engine implements locking semantics to restrict access to a workflow instance state that is saved in a data store. This can be accessed by persistence services that run in multiple processes. The locking semantics are designed to prevent persistence services that run in two different processes from loading the same workflow instance into memory at the same time. Depending on the type of environment that your persistence service is designed to support, you may choose whether to support this functionality. If you choose to support the runtime locking semantics, and if this workflow instance state has been previously locked by another process, then you should throw a <xref:System.Workflow.Runtime.WorkflowOwnershipException>. Otherwise, you should lock access to the workflow instance state in your data store. The workflow instance state can be unlocked by a call to <xref:System.Workflow.Runtime.Hosting.WorkflowPersistenceService.UnlockWorkflowInstanceState%2A> or a call to <xref:System.Workflow.Runtime.Hosting.WorkflowPersistenceService.SaveWorkflowInstanceState%2A> with the unlock parameter set to `true`.\"\n  example:\n  - \"The following example demonstrates an implementation of the `LoadWorkflowInstanceState` method. This example is from the Custom Persistence Service sample, from the FilePersistenceService.cs file. For more information, see [Custom Persistence Service Sample](http://msdn.microsoft.com/en-us/869dfadf-5298-4551-bc80-f4cf7918729d).  \\n  \\n [!code-cs[WF_Samples#266](~/add/codesnippet/csharp/wf_snippets/snippets24.cs#266)]\\n [!code-vb[WF_Samples#266](~/add/codesnippet/visualbasic/wf_snippets/snippets24.vb#266)]\"\n  syntax:\n    content: protected abstract System.Workflow.ComponentModel.Activity LoadWorkflowInstanceState (Guid instanceId);\n    parameters:\n    - id: instanceId\n      type: System.Guid\n      description: The <xref:System.Guid> of the root activity of the workflow instance.\n    return:\n      type: System.Workflow.ComponentModel.Activity\n      description: An <xref href=\"System.Workflow.ComponentModel.Activity\"></xref> that represents the root activity of the workflow instance.\n  overload: System.Workflow.Runtime.Hosting.WorkflowPersistenceService.LoadWorkflowInstanceState*\n  exceptions: []\n  platform:\n  - net462\n- uid: System.Workflow.Runtime.Hosting.WorkflowPersistenceService.RestoreFromDefaultSerializedForm(System.Byte[],System.Workflow.ComponentModel.Activity)\n  id: RestoreFromDefaultSerializedForm(System.Byte[],System.Workflow.ComponentModel.Activity)\n  parent: System.Workflow.Runtime.Hosting.WorkflowPersistenceService\n  langs:\n  - csharp\n  name: RestoreFromDefaultSerializedForm(Byte[],Activity)\n  nameWithType: WorkflowPersistenceService.RestoreFromDefaultSerializedForm(Byte[],Activity)\n  fullName: System.Workflow.Runtime.Hosting.WorkflowPersistenceService.RestoreFromDefaultSerializedForm(Byte[],Activity)\n  type: Method\n  assemblies:\n  - System.Workflow.Runtime\n  namespace: System.Workflow.Runtime.Hosting\n  summary: Restores the <xref href=\"System.Workflow.ComponentModel.Activity\"></xref> from its serialized form.\n  remarks: ''\n  example:\n  - \"The following example demonstrates an implementation of the `RestoreFromDefaultSerializedForm` method. This example is from the Custom Persistence Service sample, from the FilePersistenceService.cs file. For more information, see [Custom Persistence Service Sample](http://msdn.microsoft.com/en-us/869dfadf-5298-4551-bc80-f4cf7918729d).  \\n  \\n [!code-cs[WF_Samples#269](~/add/codesnippet/csharp/wf_snippets/snippets24.cs#269)]\\n [!code-vb[WF_Samples#269](~/add/codesnippet/visualbasic/wf_snippets/snippets24.vb#269)]\"\n  syntax:\n    content: protected static System.Workflow.ComponentModel.Activity RestoreFromDefaultSerializedForm (byte[] activityBytes, System.Workflow.ComponentModel.Activity outerActivity);\n    parameters:\n    - id: activityBytes\n      type: System.Byte[]\n      description: The serialized form of <xref href=\"System.Workflow.ComponentModel.Activity\"></xref>.\n    - id: outerActivity\n      type: System.Workflow.ComponentModel.Activity\n      description: The outer <xref href=\"System.Workflow.ComponentModel.Activity\"></xref>, containing the <xref href=\"System.Workflow.ComponentModel.Activity\"></xref> to restore.\n    return:\n      type: System.Workflow.ComponentModel.Activity\n      description: The restored <xref href=\"System.Workflow.ComponentModel.Activity\"></xref>.\n  overload: System.Workflow.Runtime.Hosting.WorkflowPersistenceService.RestoreFromDefaultSerializedForm*\n  exceptions: []\n  platform:\n  - net462\n- uid: System.Workflow.Runtime.Hosting.WorkflowPersistenceService.SaveCompletedContextActivity(System.Workflow.ComponentModel.Activity)\n  id: SaveCompletedContextActivity(System.Workflow.ComponentModel.Activity)\n  parent: System.Workflow.Runtime.Hosting.WorkflowPersistenceService\n  langs:\n  - csharp\n  name: SaveCompletedContextActivity(Activity)\n  nameWithType: WorkflowPersistenceService.SaveCompletedContextActivity(Activity)\n  fullName: System.Workflow.Runtime.Hosting.WorkflowPersistenceService.SaveCompletedContextActivity(Activity)\n  type: Method\n  assemblies:\n  - System.Workflow.Runtime\n  namespace: System.Workflow.Runtime.Hosting\n  summary: When implemented in a derived class, saves the specified completed scope to a data store.\n  remarks: \"The workflow runtime engine saves the state of completed scope activities in order to implement compensation. You must call one of the overloaded <xref:System.Workflow.ComponentModel.Activity.Save%2A> methods to serialize `activity` into a <xref:System.IO.Stream>; you may then choose to additionally process the <xref:System.IO.Stream> before writing it to your data store. However, when the workflow runtime engine calls <xref:System.Workflow.Runtime.Hosting.WorkflowPersistenceService.LoadCompletedContextActivity%2A>, you must restore an identical copy of the activity.  \\n  \\n You must be able to associate the completed scope with its enclosing workflow instance to mark the scope as unneeded in your data store when the workflow instance finishes or is terminated. Therefore, you should also save the <xref:System.Guid> of the workflow instance that is associated with the completed scope; this can be obtained from the <xref:System.Workflow.Runtime.WorkflowInstance.InstanceId%2A> property of the <xref:System.Workflow.Runtime.WorkflowInstance> associated with `activity`.  \\n  \\n <xref:System.Workflow.Runtime.Hosting.WorkflowPersistenceService.LoadCompletedContextActivity%2A> takes the <xref:System.Guid> of the completed scope as a parameter. Therefore, you must also save the <xref:System.Workflow.ComponentModel.ActivityExecutionContext.ContextGuid%2A> property associated with `activity`. This property can be referenced through the <xref:System.Workflow.ComponentModel.Activity.ActivityContextGuidProperty> field of `activity`.  \\n  \\n If you are implementing a persistence service that uses a durable store, to maintain consistency with the internal state of the workflow runtime engine, you should participate in workflow transaction batching to defer the actual write to your durable store until a workflow commit point. To participate in batching, add a work item to the <xref:System.Workflow.Runtime.WorkflowEnvironment.WorkBatch%2A> property that represents the pending changes to the database, and implement the <xref:System.Workflow.Runtime.IPendingWork> interface in your persistence service.  \\n  \\n If you cannot save the completed scope to your data store, you should throw a <xref:System.Workflow.Runtime.Hosting.PersistenceException> with an appropriate error message.\"\n  example:\n  - \"The following example demonstrates an implementation of the `SaveCompletedContextActivity` method. This example is from the Custom Persistence Service sample, from the FilePersistenceService.cs file. For more information, see [Custom Persistence Service Sample](http://msdn.microsoft.com/en-us/869dfadf-5298-4551-bc80-f4cf7918729d).  \\n  \\n [!code-cs[WF_Samples#268](~/add/codesnippet/csharp/wf_snippets/snippets24.cs#268)]\\n [!code-vb[WF_Samples#268](~/add/codesnippet/visualbasic/wf_snippets/snippets24.vb#268)]\"\n  syntax:\n    content: protected abstract void SaveCompletedContextActivity (System.Workflow.ComponentModel.Activity activity);\n    parameters:\n    - id: activity\n      type: System.Workflow.ComponentModel.Activity\n      description: An <xref href=\"System.Workflow.ComponentModel.Activity\"></xref> that represents the completed scope.\n  overload: System.Workflow.Runtime.Hosting.WorkflowPersistenceService.SaveCompletedContextActivity*\n  exceptions: []\n  platform:\n  - net462\n- uid: System.Workflow.Runtime.Hosting.WorkflowPersistenceService.SaveWorkflowInstanceState(System.Workflow.ComponentModel.Activity,System.Boolean)\n  id: SaveWorkflowInstanceState(System.Workflow.ComponentModel.Activity,System.Boolean)\n  parent: System.Workflow.Runtime.Hosting.WorkflowPersistenceService\n  langs:\n  - csharp\n  name: SaveWorkflowInstanceState(Activity,Boolean)\n  nameWithType: WorkflowPersistenceService.SaveWorkflowInstanceState(Activity,Boolean)\n  fullName: System.Workflow.Runtime.Hosting.WorkflowPersistenceService.SaveWorkflowInstanceState(Activity,Boolean)\n  type: Method\n  assemblies:\n  - System.Workflow.Runtime\n  namespace: System.Workflow.Runtime.Hosting\n  summary: When implemented in a derived class, saves the workflow instance state to a data store.\n  remarks: \"You must call one of the overloaded <xref:System.Workflow.ComponentModel.Activity.Save%2A> methods to serialize `rootActivity` into a <xref:System.IO.Stream>. You can then choose to additionally process the <xref:System.IO.Stream> before writing it to your data store. However, when the workflow runtime engine calls <xref:System.Workflow.Runtime.Hosting.WorkflowPersistenceService.LoadWorkflowInstanceState%2A>, you must restore an identical copy of the root activity. If you cannot save the workflow instance state to your data store, you should throw a <xref:System.Workflow.Runtime.Hosting.PersistenceException> with an appropriate error message.  \\n  \\n The workflow runtime engine provides locking semantics to restrict access to a workflow instance state that is saved in the data store. This can be accessed by the persistence services running in multiple hosts and pointing to the same data store. The locking semantics are designed to prevent persistence services that run in two different workflow runtimes from loading the same workflow instance into memory at the same time. Depending on the type of environment your persistence service is designed to support, you can choose whether to support this functionality. If you choose to support the runtime locking semantics, then, if a persistence service tries to save a workflow instance state that has been previously locked by another persistence service, you should throw a <xref:System.Workflow.Runtime.WorkflowOwnershipException>. If `unlock` is `true`, you should unlock access to the workflow instance state after you save it.  \\n  \\n <xref:System.Workflow.Runtime.Hosting.WorkflowPersistenceService.LoadWorkflowInstanceState%2A> takes the <xref:System.Guid> of the workflow instance as a parameter. Therefore, you should save this <xref:System.Guid>. You can also use this <xref:System.Guid> to associate the workflow instance with the saved states of its completed scopes. You must do this because you must be able to mark these completed scopes as unneeded when the workflow instance completes.  \\n  \\n The workflow runtime engine calls SaveWorkflowInstanceState a final time when the workflow instance is completed or terminated. Therefore, if <xref:System.Workflow.Runtime.Hosting.WorkflowPersistenceService.GetWorkflowStatus%2A> is equal to <xref:System.Workflow.Runtime.WorkflowStatus> or <xref:System.Workflow.Runtime.WorkflowStatus>, you can safely delete the workflow instance and all its associated completed scopes from your data store. Alternatively, you can subscribe to the <xref:System.Workflow.Runtime.WorkflowRuntime.WorkflowCompleted> or <xref:System.Workflow.Runtime.WorkflowRuntime.WorkflowTerminated> events to determine when it is safe to delete records associated with the workflow instance. Whether you actually delete the records from your data store depends on your implementation.  \\n  \\n If you implement a persistence service that uses a durable store, then, to maintain consistency with the internal state of the workflow runtime engine, you should participate in workflow transaction batching to defer the actual write to your durable store until a workflow commit point. To participate in batching, add a work item that represents the pending changes to your durable store to the <xref:System.Workflow.Runtime.WorkflowEnvironment.WorkBatch%2A> property, and implement the <xref:System.Workflow.Runtime.IPendingWork> interface in your persistence service.\"\n  example:\n  - \"The following example demonstrates an implementation of the `SaveWorkflowInstanceState` method. This example is from the Custom Persistence Service sample, from the FilePersistenceService.cs file. For more information, see [Custom Persistence Service Sample](http://msdn.microsoft.com/en-us/869dfadf-5298-4551-bc80-f4cf7918729d).  \\n  \\n [!code-cs[WF_Samples#264](~/add/codesnippet/csharp/wf_snippets/snippets24.cs#264)]\\n [!code-vb[WF_Samples#264](~/add/codesnippet/visualbasic/wf_snippets/snippets24.vb#264)]\"\n  syntax:\n    content: protected abstract void SaveWorkflowInstanceState (System.Workflow.ComponentModel.Activity rootActivity, bool unlock);\n    parameters:\n    - id: rootActivity\n      type: System.Workflow.ComponentModel.Activity\n      description: The root activity of the workflow instance.\n    - id: unlock\n      type: System.Boolean\n      description: <xref uid=\"langword_csharp_true\" name=\"true\" href=\"\"></xref> if the workflow instance should not be locked; <xref uid=\"langword_csharp_false\" name=\"false\" href=\"\"></xref> if the workflow instance should be locked.\n  overload: System.Workflow.Runtime.Hosting.WorkflowPersistenceService.SaveWorkflowInstanceState*\n  exceptions: []\n  platform:\n  - net462\n- uid: System.Workflow.Runtime.Hosting.WorkflowPersistenceService.UnloadOnIdle(System.Workflow.ComponentModel.Activity)\n  id: UnloadOnIdle(System.Workflow.ComponentModel.Activity)\n  parent: System.Workflow.Runtime.Hosting.WorkflowPersistenceService\n  langs:\n  - csharp\n  name: UnloadOnIdle(Activity)\n  nameWithType: WorkflowPersistenceService.UnloadOnIdle(Activity)\n  fullName: System.Workflow.Runtime.Hosting.WorkflowPersistenceService.UnloadOnIdle(Activity)\n  type: Method\n  assemblies:\n  - System.Workflow.Runtime\n  namespace: System.Workflow.Runtime.Hosting\n  summary: Determines whether a workflow should be unloaded when idle.\n  remarks: ''\n  example:\n  - \"The following example demonstrates an implementation of the `UnloadOnIdle` method. This example is from the Custom Persistence Service sample, from the FilePersistenceService.cs file. For more information, see [Custom Persistence Service Sample](http://msdn.microsoft.com/en-us/869dfadf-5298-4551-bc80-f4cf7918729d).  \\n  \\n [!code-cs[WF_Samples#270](~/add/codesnippet/csharp/wf_snippets/snippets24.cs#270)]\\n [!code-vb[WF_Samples#270](~/add/codesnippet/visualbasic/wf_snippets/snippets24.vb#270)]\"\n  syntax:\n    content: protected abstract bool UnloadOnIdle (System.Workflow.ComponentModel.Activity activity);\n    parameters:\n    - id: activity\n      type: System.Workflow.ComponentModel.Activity\n      description: An <xref href=\"System.Workflow.ComponentModel.Activity\"></xref> that represents the completed scope.\n    return:\n      type: System.Boolean\n      description: If <xref uid=\"langword_csharp_true\" name=\"true\" href=\"\"></xref>, the workflow runtime engine unloads the specified workflow when it becomes idle.\n  overload: System.Workflow.Runtime.Hosting.WorkflowPersistenceService.UnloadOnIdle*\n  exceptions: []\n  platform:\n  - net462\n- uid: System.Workflow.Runtime.Hosting.WorkflowPersistenceService.UnlockWorkflowInstanceState(System.Workflow.ComponentModel.Activity)\n  id: UnlockWorkflowInstanceState(System.Workflow.ComponentModel.Activity)\n  parent: System.Workflow.Runtime.Hosting.WorkflowPersistenceService\n  langs:\n  - csharp\n  name: UnlockWorkflowInstanceState(Activity)\n  nameWithType: WorkflowPersistenceService.UnlockWorkflowInstanceState(Activity)\n  fullName: System.Workflow.Runtime.Hosting.WorkflowPersistenceService.UnlockWorkflowInstanceState(Activity)\n  type: Method\n  assemblies:\n  - System.Workflow.Runtime\n  namespace: System.Workflow.Runtime.Hosting\n  summary: When overridden in a derived class, unlocks the workflow instance state.\n  remarks: \"This method is abstract, so it does not contain a default implementation on locking and unlocking.  \\n  \\n While implementing a custom persistence service, if you want to implement a locking scheme you will need to override this method and provide a locking-unlocking mechanism in the <xref:System.Workflow.Runtime.Hosting.WorkflowPersistenceService.SaveWorkflowInstanceState%2A> method based on the value of the unlock parameter.\"\n  example:\n  - \"The following example demonstrates an implementation of the `UnlockWorkflowInstanceState` method. This example is from the Custom Persistence Service sample, from the FilePersistenceService.cs file. For more information, see [Custom Persistence Service Sample](http://msdn.microsoft.com/en-us/869dfadf-5298-4551-bc80-f4cf7918729d).  \\n  \\n [!code-cs[WF_Samples#267](~/add/codesnippet/csharp/wf_snippets/snippets24.cs#267)]\\n [!code-vb[WF_Samples#267](~/add/codesnippet/visualbasic/wf_snippets/snippets24.vb#267)]\"\n  syntax:\n    content: protected abstract void UnlockWorkflowInstanceState (System.Workflow.ComponentModel.Activity rootActivity);\n    parameters:\n    - id: rootActivity\n      type: System.Workflow.ComponentModel.Activity\n      description: The root activity of the workflow instance.\n  overload: System.Workflow.Runtime.Hosting.WorkflowPersistenceService.UnlockWorkflowInstanceState*\n  exceptions: []\n  platform:\n  - net462\nreferences:\n- uid: System.Workflow.Runtime.Hosting.WorkflowRuntimeService\n  isExternal: false\n  name: System.Workflow.Runtime.Hosting.WorkflowRuntimeService\n- uid: System.Workflow.Runtime.Hosting.WorkflowPersistenceService.#ctor\n  parent: System.Workflow.Runtime.Hosting.WorkflowPersistenceService\n  isExternal: false\n  name: WorkflowPersistenceService()\n  nameWithType: WorkflowPersistenceService.WorkflowPersistenceService()\n  fullName: System.Workflow.Runtime.Hosting.WorkflowPersistenceService.WorkflowPersistenceService()\n- uid: System.Workflow.Runtime.Hosting.WorkflowPersistenceService.GetDefaultSerializedForm(System.Workflow.ComponentModel.Activity)\n  parent: System.Workflow.Runtime.Hosting.WorkflowPersistenceService\n  isExternal: false\n  name: GetDefaultSerializedForm(Activity)\n  nameWithType: WorkflowPersistenceService.GetDefaultSerializedForm(Activity)\n  fullName: System.Workflow.Runtime.Hosting.WorkflowPersistenceService.GetDefaultSerializedForm(Activity)\n- uid: System.Byte[]\n  parent: System\n  isExternal: true\n  name: Byte\n  nameWithType: Byte\n  fullName: System.Byte[]\n  spec.csharp:\n  - uid: System.Byte\n    name: Byte\n    nameWithType: Byte\n    fullName: Byte[]\n  - name: '[]'\n    nameWithType: '[]'\n    fullName: '[]'\n- uid: System.Workflow.ComponentModel.Activity\n  parent: System.Workflow.ComponentModel\n  isExternal: false\n  name: Activity\n  nameWithType: Activity\n  fullName: System.Workflow.ComponentModel.Activity\n- uid: System.Workflow.Runtime.Hosting.WorkflowPersistenceService.GetIsBlocked(System.Workflow.ComponentModel.Activity)\n  parent: System.Workflow.Runtime.Hosting.WorkflowPersistenceService\n  isExternal: false\n  name: GetIsBlocked(Activity)\n  nameWithType: WorkflowPersistenceService.GetIsBlocked(Activity)\n  fullName: System.Workflow.Runtime.Hosting.WorkflowPersistenceService.GetIsBlocked(Activity)\n- uid: System.Boolean\n  parent: System\n  isExternal: true\n  name: Boolean\n  nameWithType: Boolean\n  fullName: System.Boolean\n- uid: System.Workflow.Runtime.Hosting.WorkflowPersistenceService.GetSuspendOrTerminateInfo(System.Workflow.ComponentModel.Activity)\n  parent: System.Workflow.Runtime.Hosting.WorkflowPersistenceService\n  isExternal: false\n  name: GetSuspendOrTerminateInfo(Activity)\n  nameWithType: WorkflowPersistenceService.GetSuspendOrTerminateInfo(Activity)\n  fullName: System.Workflow.Runtime.Hosting.WorkflowPersistenceService.GetSuspendOrTerminateInfo(Activity)\n- uid: System.String\n  parent: System\n  isExternal: true\n  name: String\n  nameWithType: String\n  fullName: System.String\n- uid: System.Workflow.Runtime.Hosting.WorkflowPersistenceService.GetWorkflowStatus(System.Workflow.ComponentModel.Activity)\n  parent: System.Workflow.Runtime.Hosting.WorkflowPersistenceService\n  isExternal: false\n  name: GetWorkflowStatus(Activity)\n  nameWithType: WorkflowPersistenceService.GetWorkflowStatus(Activity)\n  fullName: System.Workflow.Runtime.Hosting.WorkflowPersistenceService.GetWorkflowStatus(Activity)\n- uid: System.Workflow.Runtime.WorkflowStatus\n  parent: System.Workflow.Runtime\n  isExternal: false\n  name: WorkflowStatus\n  nameWithType: WorkflowStatus\n  fullName: System.Workflow.Runtime.WorkflowStatus\n- uid: System.Workflow.Runtime.Hosting.WorkflowPersistenceService.LoadCompletedContextActivity(System.Guid,System.Workflow.ComponentModel.Activity)\n  parent: System.Workflow.Runtime.Hosting.WorkflowPersistenceService\n  isExternal: false\n  name: LoadCompletedContextActivity(Guid,Activity)\n  nameWithType: WorkflowPersistenceService.LoadCompletedContextActivity(Guid,Activity)\n  fullName: System.Workflow.Runtime.Hosting.WorkflowPersistenceService.LoadCompletedContextActivity(Guid,Activity)\n- uid: System.Guid\n  parent: System\n  isExternal: true\n  name: Guid\n  nameWithType: Guid\n  fullName: System.Guid\n- uid: System.Workflow.Runtime.Hosting.WorkflowPersistenceService.LoadWorkflowInstanceState(System.Guid)\n  parent: System.Workflow.Runtime.Hosting.WorkflowPersistenceService\n  isExternal: false\n  name: LoadWorkflowInstanceState(Guid)\n  nameWithType: WorkflowPersistenceService.LoadWorkflowInstanceState(Guid)\n  fullName: System.Workflow.Runtime.Hosting.WorkflowPersistenceService.LoadWorkflowInstanceState(Guid)\n- uid: System.Workflow.Runtime.Hosting.WorkflowPersistenceService.RestoreFromDefaultSerializedForm(System.Byte[],System.Workflow.ComponentModel.Activity)\n  parent: System.Workflow.Runtime.Hosting.WorkflowPersistenceService\n  isExternal: false\n  name: RestoreFromDefaultSerializedForm(Byte[],Activity)\n  nameWithType: WorkflowPersistenceService.RestoreFromDefaultSerializedForm(Byte[],Activity)\n  fullName: System.Workflow.Runtime.Hosting.WorkflowPersistenceService.RestoreFromDefaultSerializedForm(Byte[],Activity)\n- uid: System.Workflow.Runtime.Hosting.WorkflowPersistenceService.SaveCompletedContextActivity(System.Workflow.ComponentModel.Activity)\n  parent: System.Workflow.Runtime.Hosting.WorkflowPersistenceService\n  isExternal: false\n  name: SaveCompletedContextActivity(Activity)\n  nameWithType: WorkflowPersistenceService.SaveCompletedContextActivity(Activity)\n  fullName: System.Workflow.Runtime.Hosting.WorkflowPersistenceService.SaveCompletedContextActivity(Activity)\n- uid: System.Workflow.Runtime.Hosting.WorkflowPersistenceService.SaveWorkflowInstanceState(System.Workflow.ComponentModel.Activity,System.Boolean)\n  parent: System.Workflow.Runtime.Hosting.WorkflowPersistenceService\n  isExternal: false\n  name: SaveWorkflowInstanceState(Activity,Boolean)\n  nameWithType: WorkflowPersistenceService.SaveWorkflowInstanceState(Activity,Boolean)\n  fullName: System.Workflow.Runtime.Hosting.WorkflowPersistenceService.SaveWorkflowInstanceState(Activity,Boolean)\n- uid: System.Workflow.Runtime.Hosting.WorkflowPersistenceService.UnloadOnIdle(System.Workflow.ComponentModel.Activity)\n  parent: System.Workflow.Runtime.Hosting.WorkflowPersistenceService\n  isExternal: false\n  name: UnloadOnIdle(Activity)\n  nameWithType: WorkflowPersistenceService.UnloadOnIdle(Activity)\n  fullName: System.Workflow.Runtime.Hosting.WorkflowPersistenceService.UnloadOnIdle(Activity)\n- uid: System.Workflow.Runtime.Hosting.WorkflowPersistenceService.UnlockWorkflowInstanceState(System.Workflow.ComponentModel.Activity)\n  parent: System.Workflow.Runtime.Hosting.WorkflowPersistenceService\n  isExternal: false\n  name: UnlockWorkflowInstanceState(Activity)\n  nameWithType: WorkflowPersistenceService.UnlockWorkflowInstanceState(Activity)\n  fullName: System.Workflow.Runtime.Hosting.WorkflowPersistenceService.UnlockWorkflowInstanceState(Activity)\n- uid: System.Workflow.Runtime.Hosting.WorkflowPersistenceService.#ctor*\n  parent: System.Workflow.Runtime.Hosting.WorkflowPersistenceService\n  isExternal: false\n  name: WorkflowPersistenceService\n  nameWithType: WorkflowPersistenceService.WorkflowPersistenceService\n- uid: System.Workflow.Runtime.Hosting.WorkflowPersistenceService.GetDefaultSerializedForm*\n  parent: System.Workflow.Runtime.Hosting.WorkflowPersistenceService\n  isExternal: false\n  name: GetDefaultSerializedForm\n  nameWithType: WorkflowPersistenceService.GetDefaultSerializedForm\n- uid: System.Workflow.Runtime.Hosting.WorkflowPersistenceService.GetIsBlocked*\n  parent: System.Workflow.Runtime.Hosting.WorkflowPersistenceService\n  isExternal: false\n  name: GetIsBlocked\n  nameWithType: WorkflowPersistenceService.GetIsBlocked\n- uid: System.Workflow.Runtime.Hosting.WorkflowPersistenceService.GetSuspendOrTerminateInfo*\n  parent: System.Workflow.Runtime.Hosting.WorkflowPersistenceService\n  isExternal: false\n  name: GetSuspendOrTerminateInfo\n  nameWithType: WorkflowPersistenceService.GetSuspendOrTerminateInfo\n- uid: System.Workflow.Runtime.Hosting.WorkflowPersistenceService.GetWorkflowStatus*\n  parent: System.Workflow.Runtime.Hosting.WorkflowPersistenceService\n  isExternal: false\n  name: GetWorkflowStatus\n  nameWithType: WorkflowPersistenceService.GetWorkflowStatus\n- uid: System.Workflow.Runtime.Hosting.WorkflowPersistenceService.LoadCompletedContextActivity*\n  parent: System.Workflow.Runtime.Hosting.WorkflowPersistenceService\n  isExternal: false\n  name: LoadCompletedContextActivity\n  nameWithType: WorkflowPersistenceService.LoadCompletedContextActivity\n- uid: System.Workflow.Runtime.Hosting.WorkflowPersistenceService.LoadWorkflowInstanceState*\n  parent: System.Workflow.Runtime.Hosting.WorkflowPersistenceService\n  isExternal: false\n  name: LoadWorkflowInstanceState\n  nameWithType: WorkflowPersistenceService.LoadWorkflowInstanceState\n- uid: System.Workflow.Runtime.Hosting.WorkflowPersistenceService.RestoreFromDefaultSerializedForm*\n  parent: System.Workflow.Runtime.Hosting.WorkflowPersistenceService\n  isExternal: false\n  name: RestoreFromDefaultSerializedForm\n  nameWithType: WorkflowPersistenceService.RestoreFromDefaultSerializedForm\n- uid: System.Workflow.Runtime.Hosting.WorkflowPersistenceService.SaveCompletedContextActivity*\n  parent: System.Workflow.Runtime.Hosting.WorkflowPersistenceService\n  isExternal: false\n  name: SaveCompletedContextActivity\n  nameWithType: WorkflowPersistenceService.SaveCompletedContextActivity\n- uid: System.Workflow.Runtime.Hosting.WorkflowPersistenceService.SaveWorkflowInstanceState*\n  parent: System.Workflow.Runtime.Hosting.WorkflowPersistenceService\n  isExternal: false\n  name: SaveWorkflowInstanceState\n  nameWithType: WorkflowPersistenceService.SaveWorkflowInstanceState\n- uid: System.Workflow.Runtime.Hosting.WorkflowPersistenceService.UnloadOnIdle*\n  parent: System.Workflow.Runtime.Hosting.WorkflowPersistenceService\n  isExternal: false\n  name: UnloadOnIdle\n  nameWithType: WorkflowPersistenceService.UnloadOnIdle\n- uid: System.Workflow.Runtime.Hosting.WorkflowPersistenceService.UnlockWorkflowInstanceState*\n  parent: System.Workflow.Runtime.Hosting.WorkflowPersistenceService\n  isExternal: false\n  name: UnlockWorkflowInstanceState\n  nameWithType: WorkflowPersistenceService.UnlockWorkflowInstanceState\n"}